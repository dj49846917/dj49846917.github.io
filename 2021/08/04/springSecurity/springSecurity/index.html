<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>spring整合springSecurity | 杜江的博客</title><meta name="description" content="Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架。"><meta name="keywords" content="Spring Security"><meta name="author" content="杜江"><meta name="copyright" content="杜江"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2021/08/04/springSecurity/springSecurity/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="spring整合springSecurity"><meta property="og:url" content="http://yoursite.com/2021/08/04/springSecurity/springSecurity/"><meta property="og:site_name" content="杜江的博客"><meta property="og:description" content="Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架。"><meta property="og:image" content="http://yoursite.com/images/springSecurity/log.jpg"><meta property="article:published_time" content="2021-08-04T01:28:30.000Z"><meta property="article:modified_time" content="2024-04-18T03:43:57.899Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="springboot整合springSecurity" href="http://yoursite.com/2021/08/05/springSecurity/springSecurity2/"><link rel="next" title="maven高级" href="http://yoursite.com/2021/08/03/maven/maven2/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/images/hexo/avater.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">46</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">38</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">48</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#案例介绍"><span class="toc-number">1.</span> <span class="toc-text">案例介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#案例效果图"><span class="toc-number">1.1.</span> <span class="toc-text">案例效果图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启动项目进入首页"><span class="toc-number">1.1.1.</span> <span class="toc-text">启动项目进入首页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#系统管理界面"><span class="toc-number">1.1.2.</span> <span class="toc-text">系统管理界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基础数据界面"><span class="toc-number">1.1.3.</span> <span class="toc-text">基础数据界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#项目最终目录结构"><span class="toc-number">1.1.4.</span> <span class="toc-text">项目最终目录结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建表语句"><span class="toc-number">1.2.</span> <span class="toc-text">建表语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#页面部分所用技术简单说明"><span class="toc-number">1.3.</span> <span class="toc-text">页面部分所用技术简单说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前端使用adminlTE"><span class="toc-number">1.3.1.</span> <span class="toc-text">前端使用adminlTE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后台部分所用技术简单说明"><span class="toc-number">1.3.2.</span> <span class="toc-text">后台部分所用技术简单说明</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#初识权限管理"><span class="toc-number">2.</span> <span class="toc-text">初识权限管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#权限管理概念"><span class="toc-number">2.1.</span> <span class="toc-text">权限管理概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#完成权限管理需要三个对象"><span class="toc-number">2.2.</span> <span class="toc-text">完成权限管理需要三个对象</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#初识Spring-Security"><span class="toc-number">3.</span> <span class="toc-text">初识Spring Security</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security概念"><span class="toc-number">3.1.</span> <span class="toc-text">Spring Security概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security简单入门"><span class="toc-number">3.2.</span> <span class="toc-text">Spring Security简单入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建web工程并导入jar包"><span class="toc-number">3.2.1.</span> <span class="toc-text">创建web工程并导入jar包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置web-xml"><span class="toc-number">3.2.2.</span> <span class="toc-text">配置web.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#向数据库中的sys-role表添加一条数据"><span class="toc-number">3.2.3.</span> <span class="toc-text">向数据库中的sys_role表添加一条数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置spring-security-xml"><span class="toc-number">3.2.4.</span> <span class="toc-text">配置spring-security.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#将spring-security-xml配置文件引入到applicationContext-xml中"><span class="toc-number">3.2.5.</span> <span class="toc-text">将spring-security.xml配置文件引入到applicationContext.xml中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#运行结果"><span class="toc-number">3.2.6.</span> <span class="toc-text">运行结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Security过滤器链"><span class="toc-number">4.</span> <span class="toc-text">Spring Security过滤器链</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security常用过滤器介绍"><span class="toc-number">4.1.</span> <span class="toc-text">Spring Security常用过滤器介绍</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringSecurity使用自定义认证页面"><span class="toc-number">5.</span> <span class="toc-text">SpringSecurity使用自定义认证页面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#在SpringSecurity主配置文件中指定认证页面配置信息"><span class="toc-number">5.1.</span> <span class="toc-text">在SpringSecurity主配置文件中指定认证页面配置信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringSecurity的csrf防护机制"><span class="toc-number">5.2.</span> <span class="toc-text">SpringSecurity的csrf防护机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringSecurity中CsrfFilter过滤器说明"><span class="toc-number">5.2.1.</span> <span class="toc-text">SpringSecurity中CsrfFilter过滤器说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#禁用csrf防护机制"><span class="toc-number">5.2.2.</span> <span class="toc-text">禁用csrf防护机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在认证页面携带token请求"><span class="toc-number">5.2.3.</span> <span class="toc-text">在认证页面携带token请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringSecurity使用数据库数据完成认证"><span class="toc-number">6.</span> <span class="toc-text">SpringSecurity使用数据库数据完成认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#初步实现认证功能"><span class="toc-number">6.1.</span> <span class="toc-text">初步实现认证功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#让我们自己的UserService接口继承UserDetailsService"><span class="toc-number">6.1.1.</span> <span class="toc-text">让我们自己的UserService接口继承UserDetailsService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写loadUserByUsername业务"><span class="toc-number">6.1.2.</span> <span class="toc-text">编写loadUserByUsername业务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在SpringSecurity主配置文件中指定认证使用的业务对象"><span class="toc-number">6.1.3.</span> <span class="toc-text">在SpringSecurity主配置文件中指定认证使用的业务对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">6.1.4.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#优化上面的代码，全部替换成数据库的数据"><span class="toc-number">6.2.</span> <span class="toc-text">优化上面的代码，全部替换成数据库的数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加密认证"><span class="toc-number">6.3.</span> <span class="toc-text">加密认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在IOC容器中提供加密对象"><span class="toc-number">6.3.1.</span> <span class="toc-text">在IOC容器中提供加密对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改认证方法"><span class="toc-number">6.3.2.</span> <span class="toc-text">修改认证方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改添加用户的操作"><span class="toc-number">6.3.3.</span> <span class="toc-text">修改添加用户的操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#设置用户状态"><span class="toc-number">7.</span> <span class="toc-text">设置用户状态</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#判断认证用户的状态"><span class="toc-number">7.1.</span> <span class="toc-text">判断认证用户的状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#修改业务代码"><span class="toc-number">7.1.1.</span> <span class="toc-text">修改业务代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试-1"><span class="toc-number">7.1.2.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注销功能"><span class="toc-number">7.2.</span> <span class="toc-text">注销功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#remember-me"><span class="toc-number">8.</span> <span class="toc-text">remember me</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#记住我功能页面代码"><span class="toc-number">8.1.</span> <span class="toc-text">记住我功能页面代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开启remember-me过滤器"><span class="toc-number">8.2.</span> <span class="toc-text">开启remember me过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#remember-me安全性分析"><span class="toc-number">8.3.</span> <span class="toc-text">remember me安全性分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#持久化remember-me信息"><span class="toc-number">8.4.</span> <span class="toc-text">持久化remember me信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#显示当前认证用户名"><span class="toc-number">9.</span> <span class="toc-text">显示当前认证用户名</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#授权准备工作"><span class="toc-number">10.</span> <span class="toc-text">授权准备工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#动态展示菜单"><span class="toc-number">11.</span> <span class="toc-text">动态展示菜单</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#授权操作"><span class="toc-number">12.</span> <span class="toc-text">授权操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#开启授权的注解支持"><span class="toc-number">12.1.</span> <span class="toc-text">开启授权的注解支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在注解支持对应类或者方法上添加注解"><span class="toc-number">12.2.</span> <span class="toc-text">在注解支持对应类或者方法上添加注解</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#权限不足异常处理"><span class="toc-number">13.</span> <span class="toc-text">权限不足异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#方式一：在spring-security-xml配置文件中处理"><span class="toc-number">13.1.</span> <span class="toc-text">方式一：在spring-security.xml配置文件中处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方式二：在webapp-WEB-INF-web-xml中处理"><span class="toc-number">13.2.</span> <span class="toc-text">方式二：在webapp&#x2F;WEB-INF&#x2F;web.xml中处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方式三：编写异常处理器"><span class="toc-number">13.3.</span> <span class="toc-text">方式三：编写异常处理器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">14.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#springSecurity的快速入门"><span class="toc-number">14.1.</span> <span class="toc-text">springSecurity的快速入门</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="color"></div><header class="post-bg" id="page-header" style="background-image: url(/images/springSecurity/log.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">杜江的博客</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">spring整合springSecurity</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-08-04 09:28:30"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2021-08-04</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2024-04-18 11:43:57"><i class="fas fa-history fa-fw"></i> 更新于 2024-04-18</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/%E6%95%99%E7%A8%8B/">教程</a><i class="fas fa-angle-right post-meta__separator"></i><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/%E6%95%99%E7%A8%8B/springSecurity/">springSecurity</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="案例介绍"><a href="#案例介绍" class="headerlink" title="案例介绍"></a>案例介绍</h1><ul>
<li>项目基础代码在<a href="https://gitee.com/dujiang1992/spring-security-demo" target="_blank" rel="noopener">https://gitee.com/dujiang1992/spring-security-demo</a><h2 id="案例效果图"><a href="#案例效果图" class="headerlink" title="案例效果图"></a>案例效果图</h2><h3 id="启动项目进入首页"><a href="#启动项目进入首页" class="headerlink" title="启动项目进入首页"></a>启动项目进入首页</h3></li>
<li><img src= "/img/loading.gif" data-src="/images/springSecurity/%E5%87%86%E5%A4%87.jpg" alt="效果展示"></li>
</ul>
<h3 id="系统管理界面"><a href="#系统管理界面" class="headerlink" title="系统管理界面"></a>系统管理界面</h3><ul>
<li><img src= "/img/loading.gif" data-src="/images/springSecurity/%E5%87%86%E5%A4%872.jpg" alt="效果展示"></li>
</ul>
<h3 id="基础数据界面"><a href="#基础数据界面" class="headerlink" title="基础数据界面"></a>基础数据界面</h3><ul>
<li><img src= "/img/loading.gif" data-src="/images/springSecurity/%E5%87%86%E5%A4%873.jpg" alt="效果展示"></li>
</ul>
<h3 id="项目最终目录结构"><a href="#项目最终目录结构" class="headerlink" title="项目最终目录结构"></a>项目最终目录结构</h3><ul>
<li><img src= "/img/loading.gif" data-src="/images/springSecurity/%E5%87%86%E5%A4%874.jpg" alt="效果展示"></li>
</ul>
<h2 id="建表语句"><a href="#建表语句" class="headerlink" title="建表语句"></a>建表语句</h2><ul>
<li>在mysql中新建一个security_authority的表，再执行下面的sql语句<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP TABLE IF EXISTS &#96;sys_permission&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_permission&#96; (</span><br><span class="line">  &#96;ID&#96; int(11) NOT NULL AUTO_INCREMENT COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;permission_NAME&#96; varchar(30) DEFAULT NULL COMMENT &#39;菜单名称&#39;,</span><br><span class="line">  &#96;permission_url&#96; varchar(100) DEFAULT NULL COMMENT &#39;菜单地址&#39;,</span><br><span class="line">  &#96;parent_id&#96; int(11) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;父菜单id&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;sys_role&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_role&#96; (</span><br><span class="line">  &#96;ID&#96; int(11) NOT NULL AUTO_INCREMENT COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;ROLE_NAME&#96; varchar(30) DEFAULT NULL COMMENT &#39;角色名称&#39;,</span><br><span class="line">  &#96;ROLE_DESC&#96; varchar(60) DEFAULT NULL COMMENT &#39;角色描述&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;2 DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;sys_role_permission&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_role_permission&#96; (</span><br><span class="line">  &#96;RID&#96; int(11) NOT NULL COMMENT &#39;角色编号&#39;,</span><br><span class="line">  &#96;PID&#96; int(11) NOT NULL COMMENT &#39;权限编号&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;RID&#96;,&#96;PID&#96;),</span><br><span class="line"></span><br><span class="line">  KEY &#96;FK_Reference_12&#96; (&#96;PID&#96;),</span><br><span class="line">  CONSTRAINT &#96;FK_Reference_11&#96; FOREIGN KEY (&#96;RID&#96;) REFERENCES &#96;sys_role&#96; (&#96;ID&#96;),</span><br><span class="line">  CONSTRAINT &#96;FK_Reference_12&#96; FOREIGN KEY (&#96;PID&#96;) REFERENCES &#96;sys_permission&#96; (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;sys_user&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_user&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;username&#96; varchar(32) NOT NULL COMMENT &#39;用户名称&#39;,</span><br><span class="line">  &#96;password&#96; varchar(120) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#39;密码&#39;,</span><br><span class="line">  &#96;status&#96; int(1) DEFAULT &#39;1&#39; COMMENT &#39;1开启0关闭&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;2 DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;sys_user_role&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_user_role&#96; (</span><br><span class="line">  &#96;UID&#96; int(11) NOT NULL COMMENT &#39;用户编号&#39;,</span><br><span class="line">  &#96;RID&#96; int(11) NOT NULL COMMENT &#39;角色编号&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;UID&#96;,&#96;RID&#96;),</span><br><span class="line">  KEY &#96;FK_Reference_10&#96; (&#96;RID&#96;),</span><br><span class="line">  CONSTRAINT &#96;FK_Reference_10&#96; FOREIGN KEY (&#96;RID&#96;) REFERENCES &#96;sys_role&#96; (&#96;ID&#96;),</span><br><span class="line">  CONSTRAINT &#96;FK_Reference_9&#96; FOREIGN KEY (&#96;UID&#96;) REFERENCES &#96;sys_user&#96; (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="页面部分所用技术简单说明"><a href="#页面部分所用技术简单说明" class="headerlink" title="页面部分所用技术简单说明"></a>页面部分所用技术简单说明</h2><h3 id="前端使用adminlTE"><a href="#前端使用adminlTE" class="headerlink" title="前端使用adminlTE"></a>前端使用adminlTE</h3><ul>
<li>AdminLTE是一款基于Bootstrap的页面模板，可以快速构建出一套美观的后台管理页面。</li>
<li>官网地址：<a href="https://adminlte.io/" target="_blank" rel="noopener">https://adminlte.io/</a></li>
<li>下载地址：<a href="https://github.com/ColorlibHQ/AdminLTE/releases" target="_blank" rel="noopener">https://github.com/ColorlibHQ/AdminLTE/releases</a></li>
</ul>
<h3 id="后台部分所用技术简单说明"><a href="#后台部分所用技术简单说明" class="headerlink" title="后台部分所用技术简单说明"></a>后台部分所用技术简单说明</h3><ul>
<li>后台代码采用springmvc实现web层，spring控制业务层事务，mybatis操作数据库，这三个框架大家一定非常熟悉了，这里我就不再赘述！</li>
</ul>
<h1 id="初识权限管理"><a href="#初识权限管理" class="headerlink" title="初识权限管理"></a>初识权限管理</h1><h2 id="权限管理概念"><a href="#权限管理概念" class="headerlink" title="权限管理概念"></a>权限管理概念</h2><ul>
<li>权限管理，一般指根据系统设置的安全规则或者安全策略，用户可以访问而且只能访问自己被授权的资源。权限管<br>理几乎出现在任何系统里面，前提是需要有用户和密码认证的系统。<div class="note info">
            <p>在权限管理的概念中，有两个非常重要的名词：<br>认证：通过用户名和密码成功登陆系统后，让系统得到当前用户的角色身份。<br>授权：系统根据当前用户的角色，给其授予对应可以操作的权限资源</p>
          </div>

</li>
</ul>
<h2 id="完成权限管理需要三个对象"><a href="#完成权限管理需要三个对象" class="headerlink" title="完成权限管理需要三个对象"></a>完成权限管理需要三个对象</h2><ul>
<li>用户：主要包含用户名，密码和当前用户的角色信息，可实现认证操作。</li>
<li>角色：主要包含角色名称，角色描述和当前角色拥有的权限信息，可实现授权操作。</li>
<li>权限：权限也可以称为菜单，主要包含当前权限名称，url地址等信息，可实现动态展示菜单。<div class="note info">
            <p>注：这三个对象中，用户与角色是多对多的关系，角色与权限是多对多的关系，用户与权限没有直接关系，二者是通过角色来建立关联关系的。</p>
          </div>

</li>
</ul>
<h1 id="初识Spring-Security"><a href="#初识Spring-Security" class="headerlink" title="初识Spring Security"></a>初识Spring Security</h1><h2 id="Spring-Security概念"><a href="#Spring-Security概念" class="headerlink" title="Spring Security概念"></a>Spring Security概念</h2><ul>
<li>Spring Security是spring采用AOP思想，基于servlet过滤器实现的安全框架。它提供了完善的认证机制和方法级的授权功能。是一款非常优秀的权限管理框架。</li>
</ul>
<h2 id="Spring-Security简单入门"><a href="#Spring-Security简单入门" class="headerlink" title="Spring Security简单入门"></a>Spring Security简单入门</h2><ul>
<li>Spring Security博大精深，设计巧妙，功能繁杂，一言难尽，咱们还是直接上代码吧！</li>
</ul>
<h3 id="创建web工程并导入jar包"><a href="#创建web工程并导入jar包" class="headerlink" title="创建web工程并导入jar包"></a>创建web工程并导入jar包</h3><div class="note info">
            <p>Spring Security主要jar包功能介绍<br>spring-security-core.jar<br>核心包，任何Spring Security功能都需要此包。<br>spring-security-web.jar<br>web工程必备，包含过滤器和相关的Web安全基础结构代码。<br>spring-security-config.jar<br>用于解析xml配置文件，用到Spring Security的xml配置文件的就要用到此包。<br>spring-security-taglibs.jar<br>Spring Security提供的动态标签库，jsp页面可以用</p>
          </div>
<ul>
<li>在pom.xml中导入对应的包<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.security&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-security-taglibs&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.security&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-security-config&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="配置web-xml"><a href="#配置web-xml" class="headerlink" title="配置web.xml"></a>配置web.xml</h3><ul>
<li>找到webapp/WEB-INF/web.xml<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;web-app xmlns&#x3D;&quot;http:&#x2F;&#x2F;java.sun.com&#x2F;xml&#x2F;ns&#x2F;javaee&quot;</span><br><span class="line">xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;java.sun.com&#x2F;xml&#x2F;ns&#x2F;javaee</span><br><span class="line">http:&#x2F;&#x2F;java.sun.com&#x2F;xml&#x2F;ns&#x2F;javaee&#x2F;web-app_3_0.xsd&quot;</span><br><span class="line">version&#x3D;&quot;3.0&quot;&gt;</span><br><span class="line">    &lt;display-name&gt;Archetype Created Web Application&lt;&#x2F;display-name&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!--Spring Security过滤器链，注意过滤器名称必须叫springSecurityFilterChain--&gt;</span><br><span class="line">    &lt;filter&gt;</span><br><span class="line">        &lt;!-- 名称springSecurityFilterChain固定，不能修改 --&gt;</span><br><span class="line">        &lt;filter-name&gt;springSecurityFilterChain&lt;&#x2F;filter-name&gt;</span><br><span class="line">        &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;&#x2F;filter-class&gt;</span><br><span class="line">    &lt;&#x2F;filter&gt;</span><br><span class="line">    &lt;filter-mapping&gt;</span><br><span class="line">        &lt;filter-name&gt;springSecurityFilterChain&lt;&#x2F;filter-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;&#x2F;*&lt;&#x2F;url-pattern&gt;</span><br><span class="line">    &lt;&#x2F;filter-mapping&gt;</span><br><span class="line">&lt;&#x2F;web-app&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="向数据库中的sys-role表添加一条数据"><a href="#向数据库中的sys-role表添加一条数据" class="headerlink" title="向数据库中的sys_role表添加一条数据"></a>向数据库中的sys_role表添加一条数据</h3>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO &#96;sys_role&#96; VALUES (&#39;6&#39;, &#39;ROLE_USER&#39;, &#39;基本角色&#39;);</span><br></pre></td></tr></table></figure>

<h3 id="配置spring-security-xml"><a href="#配置spring-security-xml" class="headerlink" title="配置spring-security.xml"></a>配置spring-security.xml</h3><ul>
<li>在resources下新建spring-security.xml<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;</span><br><span class="line">      xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">      xmlns:security&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security&quot;</span><br><span class="line">      xsi:schemaLocation&#x3D;&quot;</span><br><span class="line">      http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans.xsd</span><br><span class="line">      http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security&#x2F;spring-security.xsd</span><br><span class="line">&quot;&gt;</span><br><span class="line">    &lt;!-- 配置springSecurity --&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        auto-config&#x3D;&quot;true&quot;  表示自动加载springSecurity配置文件</span><br><span class="line">        use-expressions&#x3D;&quot;true&quot;  表示使用spring的el表达式来配置springSecurity</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;security:http auto-config&#x3D;&quot;true&quot; use-expressions&#x3D;&quot;true&quot;&gt;</span><br><span class="line">        &lt;!-- 拦截资源 --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            &quot;ROLE_USER&quot;     是数据库sys_role里面的一条数据的ROLE_NAME</span><br><span class="line">            pattern&#x3D;&quot;&#x2F;**&quot;   表示拦截所有资源(spring中两个*表示所有，第一个*表示路径，第二个*表示子目录以及后面的目录)</span><br><span class="line">            access&#x3D;&quot;hasAnyAuthority(&#39;ROLE_USER&#39;)&quot;   表示只有ROLE_USER角色才能访问资源</span><br><span class="line">            hasAnyAuthority()   可以多个角色</span><br><span class="line">            hasRole()   1个角色</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;security:intercept-url pattern&#x3D;&quot;&#x2F;**&quot; access&#x3D;&quot;hasAnyAuthority(&#39;ROLE_USER&#39;)&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;security:http&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--设置Spring Security认证用户信息的来源--&gt;</span><br><span class="line">    &lt;!-- springSecurity默认的认证必须是加密的，加上&#123;noop&#125; 表示不加密认证 --&gt;</span><br><span class="line">    &lt;security:authentication-manager&gt;</span><br><span class="line">        &lt;security:authentication-provider&gt;</span><br><span class="line">            &lt;security:user-service&gt;</span><br><span class="line">                &lt;security:user name&#x3D;&quot;user&quot; password&#x3D;&quot;&#123;noop&#125;user&quot;</span><br><span class="line">                              authorities&#x3D;&quot;ROLE_USER&quot; &#x2F;&gt;</span><br><span class="line">                &lt;security:user name&#x3D;&quot;admin&quot; password&#x3D;&quot;&#123;noop&#125;admin&quot;</span><br><span class="line">                              authorities&#x3D;&quot;ROLE_ADMIN&quot; &#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;security:user-service&gt;</span><br><span class="line">        &lt;&#x2F;security:authentication-provider&gt;</span><br><span class="line">    &lt;&#x2F;security:authentication-manager&gt;</span><br><span class="line">&lt;&#x2F;beans&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="将spring-security-xml配置文件引入到applicationContext-xml中"><a href="#将spring-security-xml配置文件引入到applicationContext-xml中" class="headerlink" title="将spring-security.xml配置文件引入到applicationContext.xml中"></a>将spring-security.xml配置文件引入到applicationContext.xml中</h3><ul>
<li>找到resources下的applicationContext.xml<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--引入SpringSecurity主配置文件--&gt;</span><br><span class="line">&lt;import resource&#x3D;&quot;classpath:spring-security.xml&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><ul>
<li>好了！开始启动项目了，万众期待看到index.jsp中的内容！</li>
<li><img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C.jpg" alt="结果"><div class="note info">
            <p>唉！？说好的首页呢！？为何生活不是我想象！？<br>地址栏中login处理器谁写的！？这个带有歪果仁文字的页面哪来的！？这么丑！？我可以换了它吗！？<br>稍安勿躁……咱们先看看这个页面源代码，真正惊心动魄的还在后面呢……<br>这不就是一个普通的form表单吗？除了那个_csrf的input隐藏文件！<br>注意！这可是你想使用自定义页面时，排查问题的一条重要线索！<br><img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C2.jpg" alt="结果"></p><p>我们再去看看控制台发生了什么，这里我偷偷在项目中加了日志包和配置文件……<br>惊不惊喜！？意不意外！？哪来这么多过滤器啊！？<br><img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C3.jpg" alt="结果"></p><p><strong>最后，我们在这个登录页面上输入用户名user，密码user，点击Sign in，好了，总算再次看到首页了！</strong></p>
          </div>

</li>
</ul>
<h1 id="Spring-Security过滤器链"><a href="#Spring-Security过滤器链" class="headerlink" title="Spring Security过滤器链"></a>Spring Security过滤器链</h1><h2 id="Spring-Security常用过滤器介绍"><a href="#Spring-Security常用过滤器介绍" class="headerlink" title="Spring Security常用过滤器介绍"></a>Spring Security常用过滤器介绍</h2><ol>
<li>org.springframework.security.web.context.SecurityContextPersistenceFilter<blockquote>
<p>首当其冲的一个过滤器，作用之重要，自不必多言。<br>SecurityContextPersistenceFilter主要是使用SecurityContextRepository在session中保存或更新一个SecurityContext，并将SecurityContext给以后的过滤器使用，来为后续filter建立所需的上下文。<br>SecurityContext中存储了当前用户的认证以及权限信息。</p>
</blockquote>
</li>
<li>org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter<blockquote>
<p>此过滤器用于集成SecurityContext到Spring异步执行机制中的WebAsyncManager</p>
</blockquote>
</li>
<li>org.springframework.security.web.header.HeaderWriterFilter<blockquote>
<p>向请求的Header中添加相应的信息,可在http标签内部使用security:headers来控制</p>
</blockquote>
</li>
<li>org.springframework.security.web.csrf.CsrfFilter<blockquote>
<p>csrf又称跨域请求伪造，SpringSecurity会对所有post请求验证是否包含系统生成的csrf的token信息，如果不包含，则报错。起到防止csrf攻击的效果。</p>
</blockquote>
</li>
<li>org.springframework.security.web.authentication.logout.LogoutFilter<blockquote>
<p>匹配URL为/logout的请求，实现用户退出,清除认证信息。</p>
</blockquote>
</li>
<li>org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter<blockquote>
<p>认证操作全靠这个过滤器，默认匹配URL为/login且必须为POST请求。</p>
</blockquote>
</li>
<li>org.springframework.security.web.authentication.ui.DefaultLoginPageGeneratingFilter<blockquote>
<p>如果没有在配置文件中指定认证页面，则由该过滤器生成一个默认认证页面。</p>
</blockquote>
</li>
<li>org.springframework.security.web.authentication.ui.DefaultLogoutPageGeneratingFilter<blockquote>
<p>由此过滤器可以生产一个默认的退出登录页面</p>
</blockquote>
</li>
<li>org.springframework.security.web.authentication.<a href="http://www.BasicAuthenticationFilter" target="_blank" rel="noopener">www.BasicAuthenticationFilter</a><blockquote>
<p>此过滤器会自动解析HTTP请求中头部名字为Authentication，且以Basic开头的头信息。</p>
</blockquote>
</li>
<li>org.springframework.security.web.savedrequest.RequestCacheAwareFilter<blockquote>
<p>通过HttpSessionRequestCache内部维护了一个RequestCache，用于缓存HttpServletRequest</p>
</blockquote>
</li>
<li>org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter<blockquote>
<p>针对ServletRequest进行了一次包装，使得request具有更加丰富的API</p>
</blockquote>
</li>
<li>org.springframework.security.web.authentication.AnonymousAuthenticationFilter<blockquote>
<p>当SecurityContextHolder中认证信息为空,则会创建一个匿名用户存入到SecurityContextHolder中。spring security为了兼容未登录的访问，也走了一套认证流程，只不过是一个匿名的身份。</p>
</blockquote>
</li>
<li>org.springframework.security.web.session.SessionManagementFilter<blockquote>
<p>SecurityContextRepository限制同一用户开启多个会话的数量</p>
</blockquote>
</li>
<li>org.springframework.security.web.access.ExceptionTranslationFilter<blockquote>
<p>异常转换过滤器位于整个springSecurityFilterChain的后方，用来转换整个链路中出现的异常</p>
</blockquote>
</li>
<li>org.springframework.security.web.access.intercept.FilterSecurityInterceptor<blockquote>
<p>获取所配置资源访问的授权信息，根据SecurityContextHolder中存储的用户信息来决定其是否有权限。</p>
</blockquote>
<div class="note warning">
            <p>那么，是不是spring security一共就这么多过滤器呢？答案是否定的！随着spring-security.xml配置的添加，还会出现新的过滤器。<br>那么，是不是spring security每次都会加载这些过滤器呢？答案也是否定的！随着spring-security.xml配置的修改，有些过滤器可能会被去掉。</p>
          </div>

</li>
</ol>
<h1 id="SpringSecurity使用自定义认证页面"><a href="#SpringSecurity使用自定义认证页面" class="headerlink" title="SpringSecurity使用自定义认证页面"></a>SpringSecurity使用自定义认证页面</h1><h2 id="在SpringSecurity主配置文件中指定认证页面配置信息"><a href="#在SpringSecurity主配置文件中指定认证页面配置信息" class="headerlink" title="在SpringSecurity主配置文件中指定认证页面配置信息"></a>在SpringSecurity主配置文件中指定认证页面配置信息</h2><ol>
<li>修改resources/spring-security.xml<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;</span><br><span class="line">      xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">      xmlns:security&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security&quot;</span><br><span class="line">      xsi:schemaLocation&#x3D;&quot;</span><br><span class="line">      http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans.xsd</span><br><span class="line">      http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security&#x2F;spring-security.xsd</span><br><span class="line">&quot;&gt;</span><br><span class="line">    &lt;!--直接释放无需经过SpringSecurity过滤器的静态资源--&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;css&#x2F;**&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;img&#x2F;**&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;plugins&#x2F;**&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;failer.jsp&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;favicon.ico&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 配置springSecurity --&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        auto-config&#x3D;&quot;true&quot;      表示自动加载springSecurity配置文件</span><br><span class="line">        use-expressions&#x3D;&quot;true&quot;  表示使用spring的el表达式来配置springSecurity</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;security:http auto-config&#x3D;&quot;true&quot; use-expressions&#x3D;&quot;true&quot;&gt;</span><br><span class="line">        &lt;!-- 让认证页面可以匿名访问 --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            access&#x3D;&quot;permitAll()&quot;    无条件允许访问</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;security:intercept-url pattern&#x3D;&quot;&#x2F;login.jsp&quot; access&#x3D;&quot;permitAll()&quot;&gt;&lt;&#x2F;security:intercept-url&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 拦截资源 --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            &quot;ROLE_USER&quot;                             是数据库sys_role里面的一条数据的ROLE_NAME</span><br><span class="line">            pattern&#x3D;&quot;&#x2F;**&quot;                           表示拦截所有资源(spring中两个*表示所有，第一个*表示路径，第二个*表示子目录以及后面的目录)</span><br><span class="line">            access&#x3D;&quot;hasAnyAuthority(&#39;ROLE_USER&#39;)&quot;   表示只有ROLE_USER角色才能访问资源</span><br><span class="line">            hasAnyAuthority()                       可以多个角色</span><br><span class="line">            hasRole()                               1个角色</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;security:intercept-url pattern&#x3D;&quot;&#x2F;**&quot; access&#x3D;&quot;hasAnyAuthority(&#39;ROLE_USER&#39;)&quot; &#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置认证信息 --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            login-page&#x3D;&quot;&#x2F;login.jsp&quot;                     自己的登录页面</span><br><span class="line">            login-processing-url&#x3D;&quot;&#x2F;login&quot;               指定认证的处理器地址(也就是默认security启动的登录地址)</span><br><span class="line">            default-target-url&#x3D;&quot;&#x2F;index.jsp&quot;             认证通过默认跳转的url路径，如果有路径这个就没用了</span><br><span class="line">            authentication-failure-url&#x3D;&quot;&#x2F;failer.jsp&quot;    认证失败跳转的url路径</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;security:form-login login-page&#x3D;&quot;&#x2F;login.jsp&quot;</span><br><span class="line">                            login-processing-url&#x3D;&quot;&#x2F;login&quot;</span><br><span class="line">                            default-target-url&#x3D;&quot;&#x2F;index.jsp&quot;</span><br><span class="line">                            authentication-failure-url&#x3D;&quot;&#x2F;failer.jsp&quot; &#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置退出登录信息 --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            logout-url&#x3D;&quot;&#x2F;logout&quot;            指定退出的处理器地址(也就是默认security启动的退出地址)</span><br><span class="line">            logout-success-url&#x3D;&quot;&#x2F;login.jsp&quot; 退出后跳转的url路径</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;security:logout logout-url&#x3D;&quot;&#x2F;logout&quot; logout-success-url&#x3D;&quot;&#x2F;login.jsp&quot;&gt;&lt;&#x2F;security:logout&gt;</span><br><span class="line">    &lt;&#x2F;security:http&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--设置Spring Security认证用户信息的来源--&gt;</span><br><span class="line">    &lt;!-- springSecurity默认的认证必须是加密的，加上&#123;noop&#125; 表示不加密认证 --&gt;</span><br><span class="line">    &lt;security:authentication-manager&gt;</span><br><span class="line">        &lt;security:authentication-provider&gt;</span><br><span class="line">            &lt;security:user-service&gt;</span><br><span class="line">                &lt;security:user name&#x3D;&quot;user&quot; password&#x3D;&quot;&#123;noop&#125;user&quot;</span><br><span class="line">                              authorities&#x3D;&quot;ROLE_USER&quot; &#x2F;&gt;</span><br><span class="line">                &lt;security:user name&#x3D;&quot;admin&quot; password&#x3D;&quot;&#123;noop&#125;admin&quot;</span><br><span class="line">                              authorities&#x3D;&quot;ROLE_ADMIN&quot; &#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;security:user-service&gt;</span><br><span class="line">        &lt;&#x2F;security:authentication-provider&gt;</span><br><span class="line">    &lt;&#x2F;security:authentication-manager&gt;</span><br><span class="line">&lt;&#x2F;beans&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改认证页面的请求地址: 修改webapp/login.jsp<ul>
<li>修改前：<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;form action&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;login.jsp&quot; method&#x3D;&quot;post&quot;&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改后：<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;form action&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;login&quot; method&#x3D;&quot;post&quot;&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>再次启动项目后就可以看到自定义的酷炫认证页面了 <img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C4.jpg" alt="结果"></li>
<li>然后输入了用户名user，密码user，就出现了如下的界面：<img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C5.jpg" alt="结果"><div class="note danger">
            <p>403什么异常？这是SpringSecurity中的权限不足！这个异常怎么来的？还记得上面SpringSecurity内置认证页面源码中的那个_csrf隐藏input吗？问题就在这了！</p>
          </div>

</li>
</ol>
<h2 id="SpringSecurity的csrf防护机制"><a href="#SpringSecurity的csrf防护机制" class="headerlink" title="SpringSecurity的csrf防护机制"></a>SpringSecurity的csrf防护机制</h2><ul>
<li>CSRF（Cross-site request forgery）跨站请求伪造，是一种难以防范的网络攻击方式。</li>
</ul>
<h3 id="SpringSecurity中CsrfFilter过滤器说明"><a href="#SpringSecurity中CsrfFilter过滤器说明" class="headerlink" title="SpringSecurity中CsrfFilter过滤器说明"></a>SpringSecurity中CsrfFilter过滤器说明</h3><ul>
<li>自己的认证页面，请求方式为POST，但却没有携带token，所以才出现了403权限不足的异常。那么如何处理这个问题呢？<ul>
<li>方式一：直接禁用csrf，不推荐。</li>
<li>方式二：在认证页面携带token请求。</li>
</ul>
</li>
</ul>
<h3 id="禁用csrf防护机制"><a href="#禁用csrf防护机制" class="headerlink" title="禁用csrf防护机制"></a>禁用csrf防护机制</h3><ul>
<li>在resources/spring-security.xml主配置文件中添加禁用crsf防护的配置。<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;security:http auto-config&#x3D;&quot;true&quot; use-expressions&#x3D;&quot;true&quot;&gt;</span><br><span class="line">    &lt;!-- 去掉csrf拦截的过滤器 --&gt;</span><br><span class="line">    &lt;security:csrf disabled&#x3D;&quot;true&quot;&gt;&lt;&#x2F;security:csrf&gt;</span><br><span class="line">&lt;&#x2F;security:http&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="在认证页面携带token请求"><a href="#在认证页面携带token请求" class="headerlink" title="在认证页面携带token请求"></a>在认证页面携带token请求</h3><ol>
<li>修改webapp/login.jsp <img src= "/img/loading.gif" data-src="/images/springSecurity/token.jpg" alt="token"></li>
<li>注：HttpSessionCsrfTokenRepository对象负责生成token并放入session域中。</li>
<li>去掉前面删除csrf拦截过滤器的配置</li>
</ol>
<h1 id="SpringSecurity使用数据库数据完成认证"><a href="#SpringSecurity使用数据库数据完成认证" class="headerlink" title="SpringSecurity使用数据库数据完成认证"></a>SpringSecurity使用数据库数据完成认证</h1><h2 id="初步实现认证功能"><a href="#初步实现认证功能" class="headerlink" title="初步实现认证功能"></a>初步实现认证功能</h2><h3 id="让我们自己的UserService接口继承UserDetailsService"><a href="#让我们自己的UserService接口继承UserDetailsService" class="headerlink" title="让我们自己的UserService接口继承UserDetailsService"></a>让我们自己的UserService接口继承UserDetailsService</h3><ol>
<li>在数据库的sys_user表添加一条数据<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO &#96;sys_user&#96; VALUES (&#39;4&#39;, &#39;xiaoming&#39;, &#39;123&#39;, &#39;1&#39;);</span><br></pre></td></tr></table></figure></li>
<li>找到service下的UserService.java，去继承UserDetailsService<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public interface UserService extends UserDetailsService &#123;</span><br><span class="line">  public void save(SysUser user);</span><br><span class="line">  public List&lt;SysUser&gt; findAll();</span><br><span class="line">  public Map&lt;String, Object&gt; toAddRolePage(Integer id);</span><br><span class="line">  public void addRoleToUser(Integer userId, Integer[] ids);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写loadUserByUsername业务"><a href="#编写loadUserByUsername业务" class="headerlink" title="编写loadUserByUsername业务"></a>编写loadUserByUsername业务</h3></li>
</ol>
<ul>
<li>修改service.UserServiceImpl.java<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 认证业务</span><br><span class="line"> * @param username  用户在浏览器输入的用户名</span><br><span class="line"> * @return UserDetails  是springSecurity自己的用户对象</span><br><span class="line"> * @throws UsernameNotFoundException</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Override</span><br><span class="line">public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; 根据用户名做查询</span><br><span class="line">        SysUser sysUser &#x3D; userDao.findByName(username);</span><br><span class="line">        if(sysUser &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorities &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        authorities.add(new SimpleGrantedAuthority(&quot;ROLE_USER&quot;));</span><br><span class="line">        &#x2F;&#x2F; &#123;noop&#125;后面的密码，springSecurity会认为是原文</span><br><span class="line">        UserDetails userDetails &#x3D; new User(sysUser.getUsername(), &quot;&#123;noop&#125;&quot; + sysUser.getPassword(), authorities);</span><br><span class="line">        return userDetails;</span><br><span class="line">    &#125; catch(Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 认证失败</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="在SpringSecurity主配置文件中指定认证使用的业务对象"><a href="#在SpringSecurity主配置文件中指定认证使用的业务对象" class="headerlink" title="在SpringSecurity主配置文件中指定认证使用的业务对象"></a>在SpringSecurity主配置文件中指定认证使用的业务对象</h3><ul>
<li>修改resources/spring-security.xml<ul>
<li>修改前：<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;security:authentication-manager&gt;</span><br><span class="line">    &lt;security:authentication-provider&gt;</span><br><span class="line">        &lt;security:user-service&gt;</span><br><span class="line">            &lt;security:user name&#x3D;&quot;user&quot; password&#x3D;&quot;&#123;noop&#125;user&quot;</span><br><span class="line">                          authorities&#x3D;&quot;ROLE_USER&quot; &#x2F;&gt;</span><br><span class="line">            &lt;security:user name&#x3D;&quot;admin&quot; password&#x3D;&quot;&#123;noop&#125;admin&quot;</span><br><span class="line">                          authorities&#x3D;&quot;ROLE_ADMIN&quot; &#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;security:user-service&gt;</span><br><span class="line">    &lt;&#x2F;security:authentication-provider&gt;</span><br><span class="line">&lt;&#x2F;security:authentication-manager&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改后：<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;security:authentication-manager&gt;</span><br><span class="line">    &lt;!-- userServiceImpl是service.impl.UserServiceImpl.java取首字母小写 --&gt;</span><br><span class="line">    &lt;security:authentication-provider user-service-ref&#x3D;&quot;userServiceImpl&quot;&gt;</span><br><span class="line">    &lt;&#x2F;security:authentication-provider&gt;</span><br><span class="line">&lt;&#x2F;security:authentication-manager&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><ul>
<li>启动项目，输入用户名：xiaoming；密码：123; 提示登录成功</li>
</ul>
<h2 id="优化上面的代码，全部替换成数据库的数据"><a href="#优化上面的代码，全部替换成数据库的数据" class="headerlink" title="优化上面的代码，全部替换成数据库的数据"></a>优化上面的代码，全部替换成数据库的数据</h2><ol>
<li>点击用户管理，修改角色，点击保存，发现报403</li>
<li>修改webapp/pages/user-role-add.jsp的代码<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &lt;%@taglib uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot; prefix&#x3D;&quot;security&quot; %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;form action&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;user&#x2F;addRoleToUser.do&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">&lt;security:csrfInput&#x2F;&gt;</span><br></pre></td></tr></table></figure></li>
<li>再次点击保存按钮，此时数据库中的sys_user_role就有了一条数据 <img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C6.jpg" alt="结果"></li>
<li>修改service.impl.UserServiceImpl.java<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 认证业务</span><br><span class="line"> * @param username  用户在浏览器输入的用户名</span><br><span class="line"> * @return UserDetails  是springSecurity自己的用户对象</span><br><span class="line"> * @throws UsernameNotFoundException</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Override</span><br><span class="line">public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; 根据用户名做查询</span><br><span class="line">        SysUser sysUser &#x3D; userDao.findByName(username);</span><br><span class="line">        if(sysUser &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorities &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        &#x2F;&#x2F; 查询角色信息</span><br><span class="line">        List&lt;SysRole&gt; roles &#x3D; sysUser.getRoles();</span><br><span class="line">        for (SysRole role : roles) &#123;</span><br><span class="line">            authorities.add(new SimpleGrantedAuthority(role.getRoleName()));</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; &#123;noop&#125;后面的密码，springSecurity会认为是原文</span><br><span class="line">        UserDetails userDetails &#x3D; new User(sysUser.getUsername(), &quot;&#123;noop&#125;&quot; + sysUser.getPassword(), authorities);</span><br><span class="line">        return userDetails;</span><br><span class="line">    &#125; catch(Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 认证失败</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>重新启动项目，输入用户名：xiaoming；密码：123; 提示登录成功</li>
</ol>
<h2 id="加密认证"><a href="#加密认证" class="headerlink" title="加密认证"></a>加密认证</h2><h3 id="在IOC容器中提供加密对象"><a href="#在IOC容器中提供加密对象" class="headerlink" title="在IOC容器中提供加密对象"></a>在IOC容器中提供加密对象</h3><ol>
<li>找到spring-security.xml，修改其中的代码<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- 把加密对象放到ioc容器中 --&gt;</span><br><span class="line">&lt;bean id&#x3D;&quot;bCryptPasswordEncoder&quot; class&#x3D;&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--设置Spring Security认证用户信息的来源--&gt;</span><br><span class="line">&lt;security:authentication-manager&gt;</span><br><span class="line">    &lt;!-- userServiceImpl是service.impl.UserServiceImpl.java取首字母小写 --&gt;</span><br><span class="line">    &lt;security:authentication-provider user-service-ref&#x3D;&quot;userServiceImpl&quot;&gt;</span><br><span class="line">        &lt;!--指定认证使用的加密对象--&gt;</span><br><span class="line">        &lt;security:password-encoder ref&#x3D;&quot;bCryptPasswordEncoder&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;security:authentication-provider&gt;</span><br><span class="line">&lt;&#x2F;security:authentication-manager&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="修改认证方法"><a href="#修改认证方法" class="headerlink" title="修改认证方法"></a>修改认证方法</h3><ul>
<li>找到service.impl.UserServiceImpl.java, 把代码中的<code>{noop}</code>去掉<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">  * 认证业务</span><br><span class="line">  * @param username  用户在浏览器输入的用户名</span><br><span class="line">  * @return UserDetails  是springSecurity自己的用户对象</span><br><span class="line">  * @throws UsernameNotFoundException</span><br><span class="line">  *&#x2F;</span><br><span class="line"> @Override</span><br><span class="line"> public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">     try &#123;</span><br><span class="line">         &#x2F;&#x2F; 根据用户名做查询</span><br><span class="line">         SysUser sysUser &#x3D; userDao.findByName(username);</span><br><span class="line">         if(sysUser &#x3D;&#x3D; null) &#123;</span><br><span class="line">             return null;</span><br><span class="line">         &#125;</span><br><span class="line">         List&lt;SimpleGrantedAuthority&gt; authorities &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">         &#x2F;&#x2F; 获取角色信息</span><br><span class="line">         List&lt;SysRole&gt; roles &#x3D; sysUser.getRoles();</span><br><span class="line">         for (SysRole role : roles) &#123;</span><br><span class="line">             authorities.add(new SimpleGrantedAuthority(role.getRoleName()));</span><br><span class="line">         &#125;</span><br><span class="line">         &#x2F;&#x2F; &#123;noop&#125;后面的密码，springSecurity会认为是原文</span><br><span class="line">         UserDetails userDetails &#x3D; new User(sysUser.getUsername(), sysUser.getPassword(), authorities);</span><br><span class="line">         return userDetails;</span><br><span class="line">     &#125; catch(Exception e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">     &#x2F;&#x2F; 认证失败</span><br><span class="line">     return null;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="修改添加用户的操作"><a href="#修改添加用户的操作" class="headerlink" title="修改添加用户的操作"></a>修改添加用户的操作</h3><ul>
<li>找到service.impl.UserServiceImpl.java, 添加加密操作<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Transactional</span><br><span class="line">public class UserServiceImpl implements UserService &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private UserDao userDao;</span><br><span class="line">    @Autowired</span><br><span class="line">    private RoleService roleService;</span><br><span class="line">    &#x2F;&#x2F; 注入BCryptPasswordEncoder</span><br><span class="line">    @Autowired</span><br><span class="line">    private BCryptPasswordEncoder passwordEncoder;</span><br><span class="line">    @Override</span><br><span class="line">    public void save(SysUser user) &#123;</span><br><span class="line">         &#x2F;&#x2F; 将密码加密</span><br><span class="line">        user.setPassword(passwordEncoder.encode(user.getPassword()));</span><br><span class="line">        userDao.save(user);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




</li>
</ul>
<h1 id="设置用户状态"><a href="#设置用户状态" class="headerlink" title="设置用户状态"></a>设置用户状态</h1><h2 id="判断认证用户的状态"><a href="#判断认证用户的状态" class="headerlink" title="判断认证用户的状态"></a>判断认证用户的状态</h2><ul>
<li>用户认证业务里，我们封装User对象时，选择了三个构造参数的构造方法，其实还有另一个构造方法：<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  public User(String username, String password, boolean enabled, boolean accountNonExpired, boolean credentialsNonExpired, boolean accountNonLocked, Collection&lt;? extends GrantedAuthority&gt; authorities) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>可以看到，这个构造方法里多了四个布尔类型的构造参数，其实我们使用的三个构造参数的构造方法里这四个布尔值默认都被赋值为了true，那么这四个布尔值到底是何意思呢？<ul>
<li>boolean enabled 是否可用</li>
<li>boolean accountNonExpired 账户是否失效</li>
<li>boolean credentialsNonExpired 秘密是否失效</li>
<li>boolean accountNonLocked 账户是否锁定</li>
</ul>
</li>
</ul>
<h3 id="修改业务代码"><a href="#修改业务代码" class="headerlink" title="修改业务代码"></a>修改业务代码</h3><ul>
<li>修改service.impl.UserServiceImpl.java<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        &#x2F;&#x2F; 根据用户名做查询</span><br><span class="line">        SysUser sysUser &#x3D; userDao.findByName(username);</span><br><span class="line">        if(sysUser &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorities &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        &#x2F;&#x2F; 获取角色信息</span><br><span class="line">        List&lt;SysRole&gt; roles &#x3D; sysUser.getRoles();</span><br><span class="line">        for (SysRole role : roles) &#123;</span><br><span class="line">            authorities.add(new SimpleGrantedAuthority(role.getRoleName()));</span><br><span class="line">        &#125;</span><br><span class="line">        UserDetails userDetails &#x3D; new User(</span><br><span class="line">                sysUser.getUsername(),    &#x2F;&#x2F; 用户名</span><br><span class="line">                sysUser.getPassword(),    &#x2F;&#x2F; 密码</span><br><span class="line">                sysUser.getStatus() &#x3D;&#x3D; 1, &#x2F;&#x2F; 是否可用</span><br><span class="line">                true,                     &#x2F;&#x2F; 账户是否失效 </span><br><span class="line">                true,                     &#x2F;&#x2F; 秘密是否失效</span><br><span class="line">                true,                     &#x2F;&#x2F; 账户是否锁定</span><br><span class="line">                authorities);</span><br><span class="line">        return userDetails;</span><br><span class="line">    &#125; catch(Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 认证失败</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>此刻，只有用户状态为1的用户才能成功通过认证！</li>
</ul>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><ul>
<li>启动项目，在数据库中找状态为1的账号能登录进去（xiaoming, 123），找状态为0的就户提示登录失败</li>
</ul>
<h2 id="注销功能"><a href="#注销功能" class="headerlink" title="注销功能"></a>注销功能</h2><ol>
<li>修改resources/pages/header.jsp<ul>
<li>修改前：<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;div class&#x3D;&quot;pull-right&quot;&gt;</span><br><span class="line">   &lt;a href&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;login.jsp&quot;</span><br><span class="line">     class&#x3D;&quot;btn btn-default btn-flat&quot;&gt;注销&lt;&#x2F;a&gt;</span><br><span class="line"> &lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改后：<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@ taglib prefix&#x3D;&quot;security&quot; uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot;%&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class&#x3D;&quot;pull-right&quot;&gt;</span><br><span class="line">  &lt;form action&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;logout&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">    &lt;security:csrfInput&#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;注销&quot;&gt;</span><br><span class="line">  &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>启动项目，点击右上角的退出按钮测试</li>
</ol>
<h1 id="remember-me"><a href="#remember-me" class="headerlink" title="remember me"></a>remember me</h1><h2 id="记住我功能页面代码"><a href="#记住我功能页面代码" class="headerlink" title="记住我功能页面代码"></a>记住我功能页面代码</h2><blockquote>
<p>注意name和value属性的值不要写错哦！</p>
</blockquote>
<ol>
<li>找到webapp/login.jsp, 在翻看源码后发现，要想实现remember me的功能，必须有一个单选或者复选框，name为”remember-me”(不能是其他值)，value为yes、true、on、1这4个中的一个<ul>
<li><img src= "/img/loading.gif" data-src="/images/springSecurity/remember.jpg" alt="remember"></li>
</ul>
</li>
</ol>
<h2 id="开启remember-me过滤器"><a href="#开启remember-me过滤器" class="headerlink" title="开启remember me过滤器"></a>开启remember me过滤器</h2><ul>
<li>找到resources.spring-security.xml，添加过滤器<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--设置可以用spring的el表达式配置Spring Security并自动生成对应配置组件（过滤器）--&gt;</span><br><span class="line">&lt;security:http auto-config&#x3D;&quot;true&quot; use-expressions&#x3D;&quot;true&quot;&gt;</span><br><span class="line">  &lt;!--开启remember me过滤器，设置token存储时间为60秒--&gt;</span><br><span class="line">  &lt;security:remember-me token-validity-seconds&#x3D;&quot;60&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;security:http&gt;</span><br></pre></td></tr></table></figure></li>
<li>测试<ul>
<li>启动项目，左下角勾选remember me，输入账号密码登录进去后，1分钟内，关闭浏览器再次访问就不用跳转到登录页面了</li>
</ul>
</li>
</ul>
<h2 id="remember-me安全性分析"><a href="#remember-me安全性分析" class="headerlink" title="remember me安全性分析"></a>remember me安全性分析</h2><ul>
<li>记住我功能方便是大家看得见的，但是安全性却令人担忧。因为Cookie毕竟是保存在客户端的，很容易盗取，而且cookie的值还与用户名、密码这些敏感数据相关，虽然加密了，但是将敏感信息存在客户端，还是不太安全。那么这就要提醒喜欢使用此功能的，用完网站要及时手动退出登录，清空认证信息。</li>
<li>此外，SpringSecurity还提供了remember me的另一种相对更安全的实现机制 :在客户端的cookie中，仅保存一个无意义的加密串（与用户名、密码等敏感数据无关），然后在db中保存该加密串-用户信息的对应关系，自动登录时，用cookie中的加密串，到db中验证，如果通过，自动登录才算通过。</li>
</ul>
<h2 id="持久化remember-me信息"><a href="#持久化remember-me信息" class="headerlink" title="持久化remember me信息"></a>持久化remember me信息</h2><ol>
<li>创建一张表，注意这张表的名称和字段都是固定的，不要修改。<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;persistent_logins&#96; (</span><br><span class="line">  &#96;username&#96; varchar(64) NOT NULL,</span><br><span class="line">  &#96;series&#96; varchar(64) NOT NULL,</span><br><span class="line">  &#96;token&#96; varchar(64) NOT NULL,</span><br><span class="line">  &#96;last_used&#96; timestamp NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;series&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8</span><br></pre></td></tr></table></figure></li>
<li>修改resources/spring-security.xml<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">    开启remember me过滤器，</span><br><span class="line">    data-source-ref&#x3D;&quot;dataSource&quot; 指定数据库连接池</span><br><span class="line">    token-validity-seconds&#x3D;&quot;60&quot; 设置token存储时间为60秒 可省略</span><br><span class="line">    remember-me-parameter&#x3D;&quot;remember-me&quot; 指定记住的参数名 可省略</span><br><span class="line">--&gt;</span><br><span class="line">&lt;security:remember-me data-source-ref&#x3D;&quot;dataSource&quot;</span><br><span class="line">                      token-validity-seconds&#x3D;&quot;60&quot;</span><br><span class="line">                      remember-me-parameter&#x3D;&quot;remember-me&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure></li>
<li>测试：输入账号密码，点击remember me，登录后，persistent_logins表就会多出一条数据</li>
</ol>
<h1 id="显示当前认证用户名"><a href="#显示当前认证用户名" class="headerlink" title="显示当前认证用户名"></a>显示当前认证用户名</h1><ul>
<li>找到webapp/pages/header.jsp<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;span class&#x3D;&quot;hidden-xs&quot;&gt;</span><br><span class="line">    &lt;security:authentication property&#x3D;&quot;principal.username&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;span&gt;</span><br><span class="line">或者</span><br><span class="line">&lt;span class&#x3D;&quot;hidden-xs&quot;&gt;</span><br><span class="line">    &lt;security:authentication property&#x3D;&quot;name&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;span&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="授权准备工作"><a href="#授权准备工作" class="headerlink" title="授权准备工作"></a>授权准备工作</h1><blockquote>
<p>为了模拟授权操作，咱们临时编写两个业务功能：</p>
</blockquote>
<ol>
<li>contoller.OrderController.java<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.controller;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;&#x2F;order&quot;)</span><br><span class="line">public class OrderController &#123;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;findAll&quot;)</span><br><span class="line">    public String findAll()&#123;</span><br><span class="line">        return &quot;order-list&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>controller.ProductController.java<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.controller;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;&#x2F;product&quot;)</span><br><span class="line">public class ProductController &#123;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;findAll&quot;)</span><br><span class="line">    public String findAll()&#123;</span><br><span class="line">        return &quot;product-list&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>webapp/pages/aside.jsp<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;ul class&#x3D;&quot;treeview-menu&quot;&gt;</span><br><span class="line">    &lt;li id&#x3D;&quot;system-setting&quot;&gt;&lt;a</span><br><span class="line">            href&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;product&#x2F;findAll&quot;&gt;</span><br><span class="line">        &lt;i class&#x3D;&quot;fa fa-circle-o&quot;&gt;&lt;&#x2F;i&gt; 产品管理</span><br><span class="line">    &lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">    &lt;li id&#x3D;&quot;system-setting&quot;&gt;&lt;a</span><br><span class="line">            href&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;order&#x2F;findAll&quot;&gt;</span><br><span class="line">        &lt;i class&#x3D;&quot;fa fa-circle-o&quot;&gt;&lt;&#x2F;i&gt; 订单管理</span><br><span class="line">    &lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="动态展示菜单"><a href="#动态展示菜单" class="headerlink" title="动态展示菜单"></a>动态展示菜单</h1><ul>
<li>在webapp/pages/aside.jsp对每个菜单通过SpringSecurity标签库指定访问所需角色<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@ taglib prefix&#x3D;&quot;security&quot; uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul class&#x3D;&quot;treeview-menu&quot;&gt;</span><br><span class="line">    &lt;!-- 产品模块还需要产品角色，注意这里还需再次指定超级管理员 --&gt;</span><br><span class="line">    &lt;security:authorize access&#x3D;&quot;hasAnyRole(&#39;ROLE_ADMIN&#39;,&#39;ROLE_PRODUCT&#39;)&quot;&gt;</span><br><span class="line">        &lt;li id&#x3D;&quot;system-setting&quot;&gt;&lt;a</span><br><span class="line">                href&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;product&#x2F;findAll&quot;&gt;</span><br><span class="line">            &lt;i class&#x3D;&quot;fa fa-circle-o&quot;&gt;&lt;&#x2F;i&gt; 产品管理</span><br><span class="line">        &lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">    &lt;&#x2F;security:authorize&gt;</span><br><span class="line">     &lt;!-- 订单模块还需要订单角色，注意这里还需再次指定超级管理员 --&gt;</span><br><span class="line">    &lt;security:authorize access&#x3D;&quot;hasAnyRole(&#39;ROLE_ORDER&#39;, &#39;ROLE_ADMIN&#39;)&quot;&gt;</span><br><span class="line">        &lt;li id&#x3D;&quot;system-setting&quot;&gt;&lt;a</span><br><span class="line">                href&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;order&#x2F;findAll&quot;&gt;</span><br><span class="line">            &lt;i class&#x3D;&quot;fa fa-circle-o&quot;&gt;&lt;&#x2F;i&gt; 订单管理</span><br><span class="line">        &lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">    &lt;&#x2F;security:authorize&gt;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br></pre></td></tr></table></figure></li>
<li>点击页面中的用户管理，给用户添加对应的角色</li>
<li>测试： 启动项目，分别用不同的账户登录，看到的菜单不同 <img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C7.jpg" alt="结果"><div class="note danger">
            <p>那么问题来了，是不是现在已经授权成功了呢？答案是否定的！你可以试试直接去访问订单的http请求地址：<br>我们发现xiaoming其实是可以操作订单模块的，只是没有把订单功能展示给xiaoming而已！<br>总结一句：页面动态菜单的展示只是为了用户体验，并未真正控制权限！<br><img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C8.jpg" alt="结果"></p>
          </div>

</li>
</ul>
<h1 id="授权操作"><a href="#授权操作" class="headerlink" title="授权操作"></a>授权操作</h1><blockquote>
<p>说明：SpringSecurity可以通过注解的方式来控制类或者方法的访问权限。注解需要对应的注解支持，若注解放在controller类中，对应注解支持应该放在mvc配置文件中，因为controller类是有mvc配置文件扫描并创建的，同理，注解放在service类中，对应注解支持应该放在spring配置文件中。由于我们现在是模拟业务操作，并没有service业务代码，所以就把注解放在controller类中了。</p>
</blockquote>
<h2 id="开启授权的注解支持"><a href="#开启授权的注解支持" class="headerlink" title="开启授权的注解支持"></a>开启授权的注解支持</h2><blockquote>
<p>这里给大家演示三类注解，但实际开发中，用一类即可！</p>
</blockquote>
<ul>
<li>找到resources/spring-mvc.xml，添加springSecurity的注解支持<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">    开启权限控制注解支持</span><br><span class="line">    jsr250-annotations&#x3D;&quot;enabled&quot;表示支持jsr250-api的注解，需要jsr250-api的jar包</span><br><span class="line">    pre-post-annotations&#x3D;&quot;enabled&quot;表示支持spring表达式注解</span><br><span class="line">    secured-annotations&#x3D;&quot;enabled&quot;这才是SpringSecurity提供的注解</span><br><span class="line">--&gt;</span><br><span class="line">&lt;security:global-method-security jsr250-annotations&#x3D;&quot;enabled&quot;</span><br><span class="line">                                pre-post-annotations&#x3D;&quot;enabled&quot;</span><br><span class="line">                                secured-annotations&#x3D;&quot;enabled&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>
<div class="note warning">
            <p>如果把这段配置放到spring-security.xml中，是不起作用的，因为，在controller中的注解是放到spring-mvc.xml中的</p>
          </div>

</li>
</ul>
<h2 id="在注解支持对应类或者方法上添加注解"><a href="#在注解支持对应类或者方法上添加注解" class="headerlink" title="在注解支持对应类或者方法上添加注解"></a>在注解支持对应类或者方法上添加注解</h2><ol>
<li>找到controller.ProductController.java, 添加<code>@Secured</code>注解 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.controller;</span><br><span class="line">import org.springframework.security.access.annotation.Secured;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;&#x2F;product&quot;)</span><br><span class="line">public class ProductController &#123;</span><br><span class="line">    &#x2F;&#x2F; 添加角色，参考webapp&#x2F;pages&#x2F;aside.jsp</span><br><span class="line">    @Secured(&#123;&quot;ROLE_ADMIN&quot;, &quot;ROLE_PRODUCT&quot;&#125;)</span><br><span class="line">    @RequestMapping(&quot;&#x2F;findAll&quot;)</span><br><span class="line">    public String findAll()&#123;</span><br><span class="line">        return &quot;product-list&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>找到controller.OrderController.java，添加<code>@Secured</code>注解<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.controller;</span><br><span class="line">import org.springframework.security.access.annotation.Secured;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;&#x2F;order&quot;)</span><br><span class="line">public class OrderController &#123;</span><br><span class="line">    @Secured(&#123;&quot;ROLE_ORDER&quot;, &quot;ROLE_ADMIN&quot;&#125;)</span><br><span class="line">    @RequestMapping(&quot;&#x2F;findAll&quot;)</span><br><span class="line">    public String findAll()&#123;</span><br><span class="line">        return &quot;order-list&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>测试：启动项目，使用用户名：xiaoming; 密码123；登录进去，他只有查看产品菜单的权限，访问订单的url，会提示403 <img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C9.jpg" alt="结果"></li>
</ol>
<h1 id="权限不足异常处理"><a href="#权限不足异常处理" class="headerlink" title="权限不足异常处理"></a>权限不足异常处理</h1><blockquote>
<p>大家也发现了，每次权限不足都出现403页面，着实难堪！体会一下：<img src= "/img/loading.gif" data-src="/images/springSecurity/%E7%BB%93%E6%9E%9C9.jpg" alt="结果"></p>
</blockquote>
<ul>
<li>解决办法如下：</li>
</ul>
<h2 id="方式一：在spring-security-xml配置文件中处理"><a href="#方式一：在spring-security-xml配置文件中处理" class="headerlink" title="方式一：在spring-security.xml配置文件中处理"></a>方式一：在spring-security.xml配置文件中处理</h2><ul>
<li>不推荐，因为，每一个都要配置。比如说403，404<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--设置可以用spring的el表达式配置Spring Security并自动生成对应配置组件（过滤器）--&gt;</span><br><span class="line">&lt;security:http auto-config&#x3D;&quot;true&quot; use-expressions&#x3D;&quot;true&quot;&gt;</span><br><span class="line">    &lt;!--省略其它配置--&gt;</span><br><span class="line">    &lt;!--403异常处理--&gt;</span><br><span class="line">    &lt;security:access-denied-handler error-page&#x3D;&quot;&#x2F;403.jsp&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;security:http&gt;</span><br></pre></td></tr></table></figure></li>
<li>测试：启动项目，使用用户名：xiaoming; 密码123；登录进去，他只有查看产品菜单的权限，访问订单的url，跳转到403页面（完毕）</li>
</ul>
<h2 id="方式二：在webapp-WEB-INF-web-xml中处理"><a href="#方式二：在webapp-WEB-INF-web-xml中处理" class="headerlink" title="方式二：在webapp/WEB-INF/web.xml中处理"></a>方式二：在webapp/WEB-INF/web.xml中处理</h2><ul>
<li>不推荐，因为如果不是web工程，就用不了，比如说前后端分离，单比方法一要好<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;error-page&gt;</span><br><span class="line">    &lt;error-code&gt;403&lt;&#x2F;error-code&gt;</span><br><span class="line">    &lt;location&gt;&#x2F;403.jsp&lt;&#x2F;location&gt;</span><br><span class="line">&lt;&#x2F;error-page&gt;</span><br><span class="line">&lt;error-page&gt;</span><br><span class="line">    &lt;error-code&gt;404&lt;&#x2F;error-code&gt;</span><br><span class="line">    &lt;location&gt;&#x2F;404.jsp&lt;&#x2F;location&gt;</span><br><span class="line">&lt;&#x2F;error-page&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="方式三：编写异常处理器"><a href="#方式三：编写异常处理器" class="headerlink" title="方式三：编写异常处理器"></a>方式三：编写异常处理器</h2><ul>
<li>在controller下新建advice.HandlerControllerException.java<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.controller;</span><br><span class="line">import org.springframework.security.access.AccessDeniedException;</span><br><span class="line">import org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line">import org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line">@ControllerAdvice</span><br><span class="line">public class handleControllerException2 &#123;</span><br><span class="line">    &#x2F;&#x2F;只有出现AccessDeniedException异常才调转403.jsp页面</span><br><span class="line">    @ExceptionHandler(AccessDeniedException.class)</span><br><span class="line">    public String handlerException()&#123;</span><br><span class="line">        return &quot;forward:&#x2F;403.jsp&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;只有出现AccessDeniedException异常才调转403.jsp页面</span><br><span class="line">    @ExceptionHandler(RuntimeException.class)</span><br><span class="line">    public String runtimeHandlerException()&#123;</span><br><span class="line">        return &quot;forward:&#x2F;500.jsp&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="springSecurity的快速入门"><a href="#springSecurity的快速入门" class="headerlink" title="springSecurity的快速入门"></a>springSecurity的快速入门</h2><ol>
<li>在pom.xml中，导入相应的坐标<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.security&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-security-taglibs&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.security&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-security-config&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li>新建一个security_authority的数据库，并执行以下脚本 <img src= "/img/loading.gif" data-src="/images/springSecurity/quick.jpg" alt="quick"><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP TABLE IF EXISTS &#96;sys_permission&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_permission&#96; (</span><br><span class="line">  &#96;ID&#96; int(11) NOT NULL AUTO_INCREMENT COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;permission_NAME&#96; varchar(30) DEFAULT NULL COMMENT &#39;菜单名称&#39;,</span><br><span class="line">  &#96;permission_url&#96; varchar(100) DEFAULT NULL COMMENT &#39;菜单地址&#39;,</span><br><span class="line">  &#96;parent_id&#96; int(11) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;父菜单id&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;sys_role&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_role&#96; (</span><br><span class="line">  &#96;ID&#96; int(11) NOT NULL AUTO_INCREMENT COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;ROLE_NAME&#96; varchar(30) DEFAULT NULL COMMENT &#39;角色名称&#39;,</span><br><span class="line">  &#96;ROLE_DESC&#96; varchar(60) DEFAULT NULL COMMENT &#39;角色描述&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;2 DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;sys_role_permission&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_role_permission&#96; (</span><br><span class="line">  &#96;RID&#96; int(11) NOT NULL COMMENT &#39;角色编号&#39;,</span><br><span class="line">  &#96;PID&#96; int(11) NOT NULL COMMENT &#39;权限编号&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;RID&#96;,&#96;PID&#96;),</span><br><span class="line"></span><br><span class="line">  KEY &#96;FK_Reference_12&#96; (&#96;PID&#96;),</span><br><span class="line">  CONSTRAINT &#96;FK_Reference_11&#96; FOREIGN KEY (&#96;RID&#96;) REFERENCES &#96;sys_role&#96; (&#96;ID&#96;),</span><br><span class="line">  CONSTRAINT &#96;FK_Reference_12&#96; FOREIGN KEY (&#96;PID&#96;) REFERENCES &#96;sys_permission&#96; (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;sys_user&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_user&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;username&#96; varchar(32) NOT NULL COMMENT &#39;用户名称&#39;,</span><br><span class="line">  &#96;password&#96; varchar(120) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#39;密码&#39;,</span><br><span class="line">  &#96;status&#96; int(1) DEFAULT &#39;1&#39; COMMENT &#39;1开启0关闭&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;2 DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;sys_user_role&#96;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;sys_user_role&#96; (</span><br><span class="line">  &#96;UID&#96; int(11) NOT NULL COMMENT &#39;用户编号&#39;,</span><br><span class="line">  &#96;RID&#96; int(11) NOT NULL COMMENT &#39;角色编号&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;UID&#96;,&#96;RID&#96;),</span><br><span class="line">  KEY &#96;FK_Reference_10&#96; (&#96;RID&#96;),</span><br><span class="line">  CONSTRAINT &#96;FK_Reference_10&#96; FOREIGN KEY (&#96;RID&#96;) REFERENCES &#96;sys_role&#96; (&#96;ID&#96;),</span><br><span class="line">  CONSTRAINT &#96;FK_Reference_9&#96; FOREIGN KEY (&#96;UID&#96;) REFERENCES &#96;sys_user&#96; (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;persistent_logins&#96; (</span><br><span class="line">  &#96;username&#96; varchar(64) NOT NULL,</span><br><span class="line">  &#96;series&#96; varchar(64) NOT NULL,</span><br><span class="line">  &#96;token&#96; varchar(64) NOT NULL,</span><br><span class="line">  &#96;last_used&#96; timestamp NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;series&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8</span><br><span class="line"></span><br><span class="line">INSERT INTO &#96;sys_role&#96; VALUES (&#39;6&#39;, &#39;ROLE_USER&#39;, &#39;基本角色&#39;);</span><br><span class="line">INSERT INTO &#96;sys_role&#96; VALUES (&#39;7&#39;, &#39;ROLE_PRODUCT&#39;, &#39;管理产品&#39;);</span><br><span class="line">INSERT INTO &#96;sys_role&#96; VALUES (&#39;8&#39;, &#39;ROLE_ADMIN&#39;, &#39;超级管理员&#39;);</span><br><span class="line">INSERT INTO &#96;sys_role&#96; VALUES (&#39;9&#39;, &#39;ROLE_ORDER&#39;, &#39;订单管理&#39;);</span><br><span class="line"></span><br><span class="line">INSERT INTO &#96;sys_user&#96; VALUES (&#39;4&#39;, &#39;xiaoming&#39;, &#39;$2a$10$T1JPLs1zhydvidYXkQCoU.zEEVB4FbtUuhhEvJWEXtAq8CxRH4PXK&#39;, &#39;1&#39;);</span><br><span class="line">INSERT INTO &#96;sys_user&#96; VALUES (&#39;14&#39;, &#39;dujiang&#39;, &#39;$2a$10$5pc0nZR5KfE6vMwGEXl.KOoqehyAa4eFKqoGuow3qlr.M.3p9ui3G&#39;, &#39;1&#39;);</span><br><span class="line"></span><br><span class="line">INSERT INTO &#96;sys_user_role&#96; VALUES (&#39;4&#39;, &#39;6&#39;);</span><br><span class="line">INSERT INTO &#96;sys_user_role&#96; VALUES (&#39;14&#39;, &#39;6&#39;);</span><br><span class="line">INSERT INTO &#96;sys_user_role&#96; VALUES (&#39;4&#39;, &#39;7&#39;);</span><br><span class="line">INSERT INTO &#96;sys_user_role&#96; VALUES (&#39;14&#39;, &#39;9&#39;);</span><br></pre></td></tr></table></figure></li>
<li>修改webapp/login.jsp<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@ taglib prefix&#x3D;&quot;security&quot; uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot;%&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;login&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">  &lt;security:csrfInput&#x2F;&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改webapp/pages/header.jsp<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@ taglib prefix&#x3D;&quot;security&quot; uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot;%&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class&#x3D;&quot;pull-right&quot;&gt;</span><br><span class="line">  &lt;form action&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;logout&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">    &lt;security:csrfInput&#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;注销&quot;&gt;</span><br><span class="line">  &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改webapp/pages/user-role-add.jsp<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@taglib uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot; prefix&#x3D;&quot;security&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;user&#x2F;addRoleToUser.do&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">  &lt;security:csrfInput&#x2F;&gt;</span><br><span class="line">  &lt;!-- 正文区域 --&gt;</span><br><span class="line">  &lt;section class&#x3D;&quot;content&quot;&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改webapp/pages/role-add.jsp<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &lt;%@taglib uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot; prefix&#x3D;&quot;security&quot; %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;form action&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;role&#x2F;save.do&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">&lt;security:csrfInput&#x2F;&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改webapp/pages/user-add.jsp<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &lt;%@ taglib prefix&#x3D;&quot;security&quot; uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot; %&gt;</span><br><span class="line"></span><br><span class="line">  &lt;form action&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;user&#x2F;save.do&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">&lt;security:csrfInput&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;select class&#x3D;&quot;form-control select2&quot; style&#x3D;&quot;width: 100%&quot;</span><br><span class="line">    name&#x3D;&quot;status&quot;&gt;</span><br><span class="line">    &lt;option value&#x3D;&quot;0&quot;&gt;关闭&lt;&#x2F;option&gt;</span><br><span class="line">    &lt;option value&#x3D;&quot;1&quot;&gt;开启&lt;&#x2F;option&gt;</span><br><span class="line">  &lt;&#x2F;select&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改webapp/pages/aside.jsp，添加菜单对应的角色<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;%@ taglib prefix&#x3D;&quot;security&quot; uri&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;security&#x2F;tags&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul class&#x3D;&quot;treeview-menu&quot;&gt;</span><br><span class="line">    &lt;!-- 产品模块还需要产品角色，注意这里还需再次指定超级管理员 --&gt;</span><br><span class="line">    &lt;security:authorize access&#x3D;&quot;hasAnyRole(&#39;ROLE_ADMIN&#39;,&#39;ROLE_PRODUCT&#39;)&quot;&gt;</span><br><span class="line">        &lt;li id&#x3D;&quot;system-setting&quot;&gt;&lt;a</span><br><span class="line">                href&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;product&#x2F;findAll&quot;&gt;</span><br><span class="line">            &lt;i class&#x3D;&quot;fa fa-circle-o&quot;&gt;&lt;&#x2F;i&gt; 产品管理</span><br><span class="line">        &lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">    &lt;&#x2F;security:authorize&gt;</span><br><span class="line">    &lt;security:authorize access&#x3D;&quot;hasAnyRole(&#39;ROLE_ORDER&#39;, &#39;ROLE_ADMIN&#39;)&quot;&gt;</span><br><span class="line">        &lt;li id&#x3D;&quot;system-setting&quot;&gt;&lt;a</span><br><span class="line">                href&#x3D;&quot;$&#123;pageContext.request.contextPath&#125;&#x2F;order&#x2F;findAll&quot;&gt;</span><br><span class="line">            &lt;i class&#x3D;&quot;fa fa-circle-o&quot;&gt;&lt;&#x2F;i&gt; 订单管理</span><br><span class="line">        &lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">    &lt;&#x2F;security:authorize&gt;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改dao.UserDao.java<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Insert(&quot;insert into sys_user (username, password, status) values (#&#123;username&#125;, #&#123;password&#125;, #&#123;status&#125;)&quot;)</span><br><span class="line">public void save(SysUser user);</span><br></pre></td></tr></table></figure></li>
<li>修改webapp/WEB-INF/web.xml<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--Spring Security过滤器链，注意过滤器名称必须叫springSecurityFilterChain--&gt;</span><br><span class="line">&lt;filter&gt;</span><br><span class="line">    &lt;filter-name&gt;springSecurityFilterChain&lt;&#x2F;filter-name&gt;</span><br><span class="line">    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;&#x2F;filter-class&gt;</span><br><span class="line">&lt;&#x2F;filter&gt;</span><br><span class="line">&lt;filter-mapping&gt;</span><br><span class="line">    &lt;filter-name&gt;springSecurityFilterChain&lt;&#x2F;filter-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;&#x2F;*&lt;&#x2F;url-pattern&gt;</span><br><span class="line">&lt;&#x2F;filter-mapping&gt;</span><br></pre></td></tr></table></figure></li>
<li>在resources下新建spring-security.xml<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;</span><br><span class="line">      xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">      xmlns:security&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security&quot;</span><br><span class="line">      xsi:schemaLocation&#x3D;&quot;</span><br><span class="line">      http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans.xsd</span><br><span class="line">      http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security&#x2F;spring-security.xsd</span><br><span class="line">&quot;&gt;</span><br><span class="line">    &lt;!--直接释放无需经过SpringSecurity过滤器的静态资源--&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;css&#x2F;**&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;img&#x2F;**&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;plugins&#x2F;**&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;failer.jsp&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line">    &lt;security:http pattern&#x3D;&quot;&#x2F;favicon.ico&quot; security&#x3D;&quot;none&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 配置springSecurity --&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        auto-config&#x3D;&quot;true&quot;      表示自动加载springSecurity配置文件</span><br><span class="line">        use-expressions&#x3D;&quot;true&quot;  表示使用spring的el表达式来配置springSecurity</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;security:http auto-config&#x3D;&quot;true&quot; use-expressions&#x3D;&quot;true&quot;&gt;</span><br><span class="line">        &lt;!-- 让认证页面可以匿名访问 --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            access&#x3D;&quot;permitAll()&quot;    无条件允许访问</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;security:intercept-url pattern&#x3D;&quot;&#x2F;login.jsp&quot; access&#x3D;&quot;permitAll()&quot;&gt;&lt;&#x2F;security:intercept-url&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 拦截资源 --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            &quot;ROLE_USER&quot;                             是数据库sys_role里面的一条数据的ROLE_NAME</span><br><span class="line">            pattern&#x3D;&quot;&#x2F;**&quot;                           表示拦截所有资源(spring中两个*表示所有，第一个*表示路径，第二个*表示子目录以及后面的目录)</span><br><span class="line">            access&#x3D;&quot;hasAnyAuthority(&#39;ROLE_USER&#39;)&quot;   表示只有ROLE_USER角色才能访问资源</span><br><span class="line">            hasAnyAuthority()                       可以多个角色</span><br><span class="line">            hasRole()                               1个角色</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;security:intercept-url pattern&#x3D;&quot;&#x2F;**&quot; access&#x3D;&quot;hasAnyAuthority(&#39;ROLE_USER&#39;)&quot; &#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置认证信息 --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            login-page&#x3D;&quot;&#x2F;login.jsp&quot;                     自己的登录页面</span><br><span class="line">            login-processing-url&#x3D;&quot;&#x2F;login&quot;               指定认证的处理器地址(也就是默认security启动的登录地址)</span><br><span class="line">            default-target-url&#x3D;&quot;&#x2F;index.jsp&quot;             认证通过默认跳转的url路径，如果有路径这个就没用了</span><br><span class="line">            authentication-failure-url&#x3D;&quot;&#x2F;failer.jsp&quot;    认证失败跳转的url路径</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;security:form-login login-page&#x3D;&quot;&#x2F;login.jsp&quot;</span><br><span class="line">                            login-processing-url&#x3D;&quot;&#x2F;login&quot;</span><br><span class="line">                            default-target-url&#x3D;&quot;&#x2F;index.jsp&quot;</span><br><span class="line">                            authentication-failure-url&#x3D;&quot;&#x2F;failer.jsp&quot; &#x2F;&gt;</span><br><span class="line">        &lt;!-- 配置退出登录信息 --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            logout-url&#x3D;&quot;&#x2F;logout&quot;            指定退出的处理器地址(也就是默认security启动的退出地址)</span><br><span class="line">            logout-success-url&#x3D;&quot;&#x2F;login.jsp&quot; 退出后跳转的url路径</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;security:logout logout-url&#x3D;&quot;&#x2F;logout&quot; logout-success-url&#x3D;&quot;&#x2F;login.jsp&quot;&gt;&lt;&#x2F;security:logout&gt;</span><br><span class="line">        &lt;!-- 开启remember me过滤器，设置token存储的时间为60秒 --&gt;</span><br><span class="line">        &lt;security:remember-me token-validity-seconds&#x3D;&quot;60&quot;</span><br><span class="line">                              remember-me-parameter&#x3D;&quot;remember-me&quot;</span><br><span class="line">                              data-source-ref&#x3D;&quot;dataSource&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;security:http&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 把加密对象放到ioc容器中 --&gt;</span><br><span class="line">    &lt;bean id&#x3D;&quot;bCryptPasswordEncoder&quot; class&#x3D;&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--设置Spring Security认证用户信息的来源--&gt;</span><br><span class="line">    &lt;!-- springSecurity默认的认证必须是加密的，加上&#123;noop&#125; 表示不加密认证 --&gt;</span><br><span class="line">    &lt;security:authentication-manager&gt;</span><br><span class="line">        &lt;!-- userServiceImpl是service.impl.UserServiceImpl.java取首字母小写 --&gt;</span><br><span class="line">        &lt;security:authentication-provider user-service-ref&#x3D;&quot;userServiceImpl&quot;&gt;</span><br><span class="line">            &lt;security:password-encoder ref&#x3D;&quot;bCryptPasswordEncoder&quot; &#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;security:authentication-provider&gt;</span><br><span class="line">    &lt;&#x2F;security:authentication-manager&gt;</span><br><span class="line">&lt;&#x2F;beans&gt;</span><br></pre></td></tr></table></figure></li>
<li>在resources/applicationContext.xml中引入spring-security.xml<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--引入spring-security文件--&gt;</span><br><span class="line">&lt;import resource&#x3D;&quot;classpath:spring-security.xml&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改resources/spring-mvc.xml<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&quot;</span><br><span class="line">        xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">        xmlns:context&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context&quot;</span><br><span class="line">        xmlns:security&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security&quot;</span><br><span class="line">        xmlns:mvc&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;mvc&quot;</span><br><span class="line">        xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans</span><br><span class="line">          http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;beans&#x2F;spring-beans.xsd</span><br><span class="line">          http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context</span><br><span class="line">          http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;context&#x2F;spring-context.xsd</span><br><span class="line">          http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security</span><br><span class="line">          http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;security&#x2F;spring-security.xsd</span><br><span class="line">          http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;mvc</span><br><span class="line">          http:&#x2F;&#x2F;www.springframework.org&#x2F;schema&#x2F;mvc&#x2F;spring-mvc.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package&#x3D;&quot;com.itheima.controller&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mvc:annotation-driven&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean class&#x3D;&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;prefix&quot; value&#x3D;&quot;&#x2F;pages&#x2F;&quot;&#x2F;&gt;</span><br><span class="line">        &lt;property name&#x3D;&quot;suffix&quot; value&#x3D;&quot;.jsp&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mvc:default-servlet-handler&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--</span><br><span class="line">        开启权限控制注解支持</span><br><span class="line">        jsr250-annotations&#x3D;&quot;enabled&quot;表示支持jsr250-api的注解，需要jsr250-api的jar包</span><br><span class="line">        pre-post-annotations&#x3D;&quot;enabled&quot;表示支持spring表达式注解</span><br><span class="line">        secured-annotations&#x3D;&quot;enabled&quot;这才是SpringSecurity提供的注解</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;security:global-method-security jsr250-annotations&#x3D;&quot;enabled&quot;</span><br><span class="line">                                    pre-post-annotations&#x3D;&quot;enabled&quot;</span><br><span class="line">                                    secured-annotations&#x3D;&quot;enabled&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;beans&gt;</span><br></pre></td></tr></table></figure></li>
<li>修改service.UserService.java，去继承UserDetailsService<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.service;</span><br><span class="line">import com.itheima.domain.SysUser;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">public interface UserService extends UserDetailsService &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>修改service.impl.UserServiceImpl.java<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.service.impl;</span><br><span class="line">import com.itheima.dao.UserDao;</span><br><span class="line">import com.itheima.domain.SysRole;</span><br><span class="line">import com.itheima.domain.SysUser;</span><br><span class="line">import com.itheima.service.RoleService;</span><br><span class="line">import com.itheima.service.UserService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line">import org.springframework.security.core.userdetails.User;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line">import org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line">import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">@Service</span><br><span class="line">@Transactional</span><br><span class="line">public class UserServiceImpl implements UserService &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private UserDao userDao;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RoleService roleService;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 注入BCryptPasswordEncoder</span><br><span class="line">    @Autowired</span><br><span class="line">    private BCryptPasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void save(SysUser user) &#123;</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        &#x2F;&#x2F; 将密码加密</span><br><span class="line">        user.setPassword(passwordEncoder.encode(user.getPassword()));</span><br><span class="line">        userDao.save(user);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;SysUser&gt; findAll() &#123;</span><br><span class="line">        return userDao.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Map&lt;String, Object&gt; toAddRolePage(Integer id) &#123;</span><br><span class="line">        List&lt;SysRole&gt; allRoles &#x3D; roleService.findAll();</span><br><span class="line">        List&lt;Integer&gt; myRoles &#x3D; userDao.findRolesByUid(id);</span><br><span class="line">        Map&lt;String, Object&gt; map &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        map.put(&quot;allRoles&quot;, allRoles);</span><br><span class="line">        map.put(&quot;myRoles&quot;, myRoles);</span><br><span class="line">        return map;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void addRoleToUser(Integer userId, Integer[] ids) &#123;</span><br><span class="line">        userDao.removeRoles(userId);</span><br><span class="line">        for (Integer rid : ids) &#123;</span><br><span class="line">            userDao.addRoles(userId, rid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">    * 认证业务</span><br><span class="line">    * @param username  用户在浏览器输入的用户名</span><br><span class="line">    * @return UserDetails  是springSecurity自己的用户对象</span><br><span class="line">    * @throws UsernameNotFoundException</span><br><span class="line">    *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 根据用户名做查询</span><br><span class="line">            SysUser sysUser &#x3D; userDao.findByName(username);</span><br><span class="line">            if(sysUser &#x3D;&#x3D; null) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;SimpleGrantedAuthority&gt; authorities &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">            &#x2F;&#x2F; 获取角色信息</span><br><span class="line">            List&lt;SysRole&gt; roles &#x3D; sysUser.getRoles();</span><br><span class="line">            for (SysRole role : roles) &#123;</span><br><span class="line">                authorities.add(new SimpleGrantedAuthority(role.getRoleName()));</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; &#123;noop&#125;后面的密码，springSecurity会认为是原文</span><br><span class="line">            UserDetails userDetails &#x3D; new User(</span><br><span class="line">                    sysUser.getUsername(),</span><br><span class="line">                    sysUser.getPassword(),</span><br><span class="line">                    sysUser.getStatus() &#x3D;&#x3D; 1,</span><br><span class="line">                    true,</span><br><span class="line">                    true,</span><br><span class="line">                    true,</span><br><span class="line">                    authorities);</span><br><span class="line">            return userDetails;</span><br><span class="line">        &#125; catch(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 认证失败</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>找到controller.ProductController.java, 添加<code>@Secured</code>注解<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.controller;</span><br><span class="line">import org.springframework.security.access.annotation.Secured;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;&#x2F;product&quot;)</span><br><span class="line">public class ProductController &#123;</span><br><span class="line">    &#x2F;&#x2F; 添加角色，参考webapp&#x2F;pages&#x2F;aside.jsp</span><br><span class="line">    @Secured(&#123;&quot;ROLE_ADMIN&quot;, &quot;ROLE_PRODUCT&quot;&#125;)</span><br><span class="line">    @RequestMapping(&quot;&#x2F;findAll&quot;)</span><br><span class="line">    public String findAll()&#123;</span><br><span class="line">        return &quot;product-list&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>找到controller.OrderController.java，添加<code>@Secured</code>注解<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.controller;</span><br><span class="line">import org.springframework.security.access.annotation.Secured;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">@Controller</span><br><span class="line">@RequestMapping(&quot;&#x2F;order&quot;)</span><br><span class="line">public class OrderController &#123;</span><br><span class="line">    @Secured(&#123;&quot;ROLE_ORDER&quot;, &quot;ROLE_ADMIN&quot;&#125;)</span><br><span class="line">    @RequestMapping(&quot;&#x2F;findAll&quot;)</span><br><span class="line">    public String findAll()&#123;</span><br><span class="line">        return &quot;order-list&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在controller下新建advice.HandlerControllerException.java<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com.itheima.controller;</span><br><span class="line">import org.springframework.security.access.AccessDeniedException;</span><br><span class="line">import org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line">import org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line">@ControllerAdvice</span><br><span class="line">public class handleControllerException2 &#123;</span><br><span class="line">    &#x2F;&#x2F;只有出现AccessDeniedException异常才调转403.jsp页面</span><br><span class="line">    @ExceptionHandler(AccessDeniedException.class)</span><br><span class="line">    public String handlerException()&#123;</span><br><span class="line">        return &quot;forward:&#x2F;403.jsp&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;只有出现AccessDeniedException异常才调转403.jsp页面</span><br><span class="line">    @ExceptionHandler(RuntimeException.class)</span><br><span class="line">    public String runtimeHandlerException()&#123;</span><br><span class="line">        return &quot;forward:&#x2F;500.jsp&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>启动tomcat, 输入用户名：xiaoming; 密码：123，提示登录成功</li>
</ol>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">杜江</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2021/08/04/springSecurity/springSecurity/">http://yoursite.com/2021/08/04/springSecurity/springSecurity/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">杜江的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring-Security/">spring Security</a></div><div class="post_share"><div class="social-share" data-image="/images/hexo/hexo_logo.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/08/05/springSecurity/springSecurity2/"><img class="prev-cover" data-src="/images/springSecurity/log.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">springboot整合springSecurity</div></div></a></div><div class="next-post pull-right"><a href="/2021/08/03/maven/maven2/"><img class="next-cover" data-src="/images/maven/log.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">maven高级</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/08/05/springSecurity/springSecurity2/" title="springboot整合springSecurity"><img class="relatedPosts_cover" data-src="/images/springSecurity/log.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-05</div><div class="relatedPosts_title">springboot整合springSecurity</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC81MDYyNy8yNzExMA=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 杜江</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://dj49846917.github.io/" target="_blank" rel="noopener">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">繁</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fas fa-comments"></i></a><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="/js/third-party/canvas-nest.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/third-party/click_heart.js"></script></body></html>